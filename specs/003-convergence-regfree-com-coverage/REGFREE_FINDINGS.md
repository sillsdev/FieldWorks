# Registration-Free COM Findings

## Current Status (2025-11-20)

### Issue: Application Startup Failure (RESOLVED)
`FieldWorks.exe` was failing to start with a Side-by-Side (SxS) configuration error. This has been resolved.

### Error Details (Historical)
**Event Log ID 33 (SideBySide):**
```
Activation context generation failed for "C:\Users\johnm\Documents\repos\FieldWorks\Output\Debug\FieldWorks.exe".
Error in manifest or policy file "C:\Users\johnm\Documents\repos\FieldWorks\Output\Debug\FwUtils.dll.MANIFEST" on line 5.
The element clrClass appears as a child of element urn:schemas-microsoft-com:asm.v1^file which is not supported by this version of Windows.
```

### Resolution Analysis
The root cause was identified as a conflict between the default manifest embedded by the .NET SDK and the custom Registration-Free COM manifest generated by `RegFree.targets`.

1.  **Manifest Structure Fix**: The `RegFree.targets` build logic correctly places `<clrClass>` elements as children of `<assembly>`, not `<file>`. The error message in the findings was misleading or referred to an intermediate state where the embedded manifest was interfering with the external one.
2.  **Embedded Manifest Disabled**: We added `<NoWin32Manifest>true</NoWin32Manifest>` to `FieldWorks.csproj`. This prevents the SDK from embedding a default manifest that overrides the external `FieldWorks.exe.manifest`.
3.  **Managed COM Registration**: We updated `BuildInclude.targets` to explicitly include managed assemblies (like `LexTextDll`, `FwUtils`) in the `ManagedComAssemblies` list. This ensures `RegFree.targets` generates the correct manifest fragments for them.

### Verification
- `FieldWorks.exe` now starts successfully without SxS errors.
- Generated manifests (e.g., `FwUtils.manifest`) show the correct structure:
  ```xml
  <assembly ...>
      <file name="FwUtils.dll" ... />
      <clrClass ... /> <!-- Child of assembly, NOT file -->
  </assembly>
  ```
- `FieldWorks.exe` has no embedded manifest (verified with `mt.exe -inputresource:FieldWorks.exe -validate`).

### Conclusion
The startup crash is resolved. The Registration-Free COM implementation for `FieldWorks.exe` is functional.
2.  Check if `FwUtils.dll` has an embedded manifest.
3.  Try removing `.dll` from the `assemblyIdentity` name in `FwUtils.dll.MANIFEST` (and updating `FieldWorks.exe.manifest` to match) to see if it's a naming issue.
4.  Validate `RegFreeCreator.cs` logic for generating these manifests.
