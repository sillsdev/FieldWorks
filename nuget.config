<?xml version="1.0" encoding="utf-8"?>
<!--
  NuGet Configuration for FieldWorks
  ===================================

  This file configures NuGet package restoration behavior across all build environments.

  PACKAGE CACHE LOCATION
  ======================
  By default, packages are restored to the local 'packages/' folder in the repo root.
  This keeps dependencies isolated per checkout and matches historical FieldWorks behavior.

  DOCKER CONTAINER BUILDS (Hybrid Cache Strategy)
  ================================================
  When building inside Docker containers (used for git worktree isolation), containers use
  a HYBRID caching strategy that balances performance and isolation:

  SHARED (on Docker named volume 'fw-nuget-cache'):
    - C:\NuGetCache\packages\    - global-packages (download once, all agents read)
    - C:\NuGetCache\http-cache\  - HTTP cache (feed metadata, safe to share)

  ISOLATED (container-local filesystem):
    - C:\Temp\NuGetScratch\      - temp extraction (per-container, no race conditions)

  Why hybrid?
    - global-packages: Read-only after initial extraction, safe to share
    - http-cache: Cached HTTP responses, rarely written, safe to share
    - temp: Active file operations during extraction, MUST be isolated

  Container setup (handled by spin-up-agents.ps1):
    * Creates named volume: fw-nuget-cache
    * Mounts volume at: C:\NuGetCache
    * Sets NUGET_PACKAGES=C:\NuGetCache\packages (shared)
    * Sets NUGET_HTTP_CACHE_PATH=C:\NuGetCache\http-cache (shared)
    * Sets TEMP/TMP=C:\Temp (container-local, isolated)
    * Uses Hyper-V isolation to fix MoveFile bug (moby/moby#38256)

  First-run behavior:
    If the shared volume is empty, the first restore downloads all packages.
    Subsequent containers/builds find packages already cached.

  Configuration precedence (highest to lowest):
    1. NUGET_PACKAGES environment variable (containers use this)
    2. globalPackagesFolder in nuget.config (host builds use this)
    3. Default: %USERPROFILE%\.nuget\packages

  IMPORTANT: The host's packages/ folder is bind-mounted into containers but
  should NOT be used as the package source for container builds. The NUGET_PACKAGES
  env var ensures containers use the named volume instead.

  See: scripts/spin-up-agents.ps1 (container creation with named volume)
  See: DOCKER.md (NuGet Cache: Named Volume Strategy section)
  See: .cache/NUGET_CONTAINER_CACHE_ANALYSIS.md (full analysis)

  PACKAGE SOURCES
  ===============
  Uses standard NuGet.org feed. Additional feeds can be added here if needed for
  private packages or local development.
-->
<configuration>
  <config>
    <!--
      globalPackagesFolder: Where NuGet extracts and caches packages.

      Host builds: Uses 'packages/' relative to solution (this setting)
      Container builds: Uses NUGET_PACKAGES env var (C:\NuGetCache\packages on named volume)

      The NUGET_PACKAGES env var always takes precedence when set.
    -->
    <add key="globalPackagesFolder" value="packages" />
  </config>

  <packageSources>
    <add key="nuget.org" value="https://api.nuget.org/v3/index.json" protocolVersion="3" />
  </packageSources>

  <packageSourceMapping>
    <!-- Require all packages to come from nuget.org (security best practice) -->
    <packageSource key="nuget.org">
      <package pattern="*" />
    </packageSource>
  </packageSourceMapping>
</configuration>
