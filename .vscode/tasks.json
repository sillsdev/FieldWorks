{
  // FieldWorks VS Code Tasks
  // See: https://go.microsoft.com/fwlink/?LinkId=733558
  //
  // Design principles:
  // - Use ./build.ps1 and ./test.ps1 (they auto-detect worktrees/containers)
  // - Avoid hardcoded paths that vary by machine
  // - Tasks with inputs can't be auto-run by agents
  // - Keep task names concise for easier discovery
  "version": "2.0.0",
  "inputs": [
    {
      "id": "agentCount",
      "type": "promptString",
      "description": "Number of agents to spin up",
      "default": "3"
    },
    {
      "id": "copilotFolders",
      "type": "promptString",
      "description": "Space-separated Src/<Folder> entries to refresh",
      "default": "Src/Common"
    },
    {
      "id": "testFilter",
      "type": "promptString",
      "description": "VSTest filter (e.g., 'TestCategory!=Slow' or 'FullyQualifiedName~FwUtils')",
      "default": ""
    },
    {
      "id": "testConfiguration",
      "type": "pickString",
      "description": "Test configuration (matches test.ps1 -Configuration)",
      "options": ["Debug", "Release"],
      "default": "Debug"
    },
    {
      "id": "testVerbosity",
      "type": "pickString",
      "description": "Test verbosity (matches test.ps1 -Verbosity)",
      "options": ["quiet", "minimal", "normal", "detailed"],
      "default": "normal"
    },
    {
      "id": "testProject",
      "type": "promptString",
      "description": "Path to test project (e.g., Src/Common/FwUtils/FwUtilsTests)",
      "default": ""
    }
  ],
  "tasks": [
    // ==================== Setup Tasks ====================
    {
      "label": "Setup: Colorize Worktree",
      "type": "shell",
      "command": "./scripts/Setup-WorktreeColor.ps1 -VSCodeWorkspaceFile \"${workspaceFile}\"",
      "detail": "Sets a unique window color based on the worktree path",
      "runOptions": {
        "runOn": "folderOpen"
      },
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      },
      "presentation": {
        "reveal": "silent",
        "panel": "shared"
      }
    },
    {
      "label": "Worktree: Open (picker)",
      "type": "shell",
      "command": "./scripts/Setup-WorktreeColor.ps1 -Action Launch",
      "detail": "Pick a git worktree and open it in a new VS Code window with colorization",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "presentation": {
        "reveal": "always",
        "panel": "shared"
      }
    },
    // ==================== Build Tasks ====================
    {
      "label": "dotnet: build",
      "type": "shell",
      "command": "./build.ps1",
      "detail": "Override: build FieldWorks via build.ps1 (required build order & custom tasks)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Build",
      "type": "shell",
      "command": "./build.ps1",
      "group": {
        "kind": "build",
        "isDefault": true
      },
      "detail": "Build FieldWorks (auto-detects worktree/container)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Build Release",
      "type": "shell",
      "command": "./build.ps1 -Configuration Release",
      "group": "build",
      "detail": "Build FieldWorks in Release configuration",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },

    // ==================== Test Tasks ====================
    {
      "label": "dotnet: test",
      "type": "shell",
      "command": "./test.ps1",
      "detail": "Override: run FieldWorks tests via test.ps1 (handles build/test conventions)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Test",
      "type": "shell",
      "command": "./test.ps1",
      "group": {
        "kind": "test",
        "isDefault": true
      },
      "detail": "Run all tests (auto-detects worktree/container)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Test (list tests)",
      "type": "shell",
      "command": "./test.ps1 -ListTests -NoBuild -Configuration ${input:testConfiguration} -Verbosity ${input:testVerbosity}",
      "group": "test",
      "detail": "List tests via test.ps1 (requires existing built test assemblies)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Test (with filter)",
      "type": "shell",
      "command": "./test.ps1 -TestFilter '${input:testFilter}' -Configuration ${input:testConfiguration} -Verbosity ${input:testVerbosity}",
      "group": "test",
      "detail": "Run tests with a filter expression",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Test (specific project)",
      "type": "shell",
      "command": "./test.ps1 -TestProject '${input:testProject}' -Configuration ${input:testConfiguration} -Verbosity ${input:testVerbosity}",
      "group": "test",
      "detail": "Run tests from a specific project",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Test (no build)",
      "type": "shell",
      "command": "./test.ps1 -NoBuild -Configuration ${input:testConfiguration} -Verbosity ${input:testVerbosity}",
      "group": "test",
      "detail": "Run tests without rebuilding (uses existing binaries)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Test (native)",
      "type": "shell",
      "command": "./test.ps1 -Native -Configuration ${input:testConfiguration}",
      "group": "test",
      "detail": "Run native tests via test.ps1 (dispatches to scripts/Agent/Invoke-CppTest.ps1)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Test (native, no build)",
      "type": "shell",
      "command": "./test.ps1 -Native -NoBuild -Configuration ${input:testConfiguration}",
      "group": "test",
      "detail": "Run native tests via test.ps1 without rebuilding",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },

    // ==================== CI Parity Checks ====================
    {
      "label": "CI: Whitespace check",
      "type": "shell",
      "command": "./Build/Agent/check-and-fix-whitespace.ps1",
      "detail": "Check and fix whitespace issues (matches CI)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "CI: Commit messages",
      "type": "shell",
      "command": "./Build/Agent/commit-messages.ps1",
      "detail": "Lint commit messages (matches CI)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "CI: Full local check",
      "dependsOn": [
        "CI: Commit messages",
        "CI: Whitespace check"
      ],
      "dependsOrder": "sequence",
      "detail": "Run all CI checks locally before pushing"
    },

    // ==================== Environment Setup ====================
    {
      "label": "Setup: Verify dependencies",
      "type": "shell",
      "command": ".\\Build\\Agent\\Verify-FwDependencies.ps1 -IncludeOptional",
      "detail": "Check all required build dependencies (VS, MSBuild, .NET, WiX)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "Setup: Defender exclusions (preview)",
      "type": "shell",
      "command": ".\\Build\\Agent\\Setup-DefenderExclusions.ps1 -DryRun",
      "detail": "Preview Windows Defender exclusions for faster builds",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "Setup: Serena MCP",
      "type": "shell",
      "command": ".\\Build\\Agent\\Setup-Serena.ps1",
      "detail": "Verify Serena MCP and language servers",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "Setup: Full environment check",
      "dependsOn": [
        "Setup: Verify dependencies",
        "Setup: Serena MCP"
      ],
      "dependsOrder": "sequence",
      "detail": "Run all environment verification steps"
    },

    // ==================== Installer ====================
    {
      "label": "Installer: Validate prerequisites",
      "type": "shell",
      "command": ".\\Build\\Agent\\Setup-InstallerBuild.ps1 -ValidateOnly",
      "detail": "Validate WiX, VS, and helper repos for installer builds",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "Installer: Setup for patch builds",
      "type": "shell",
      "command": ".\\Build\\Agent\\Setup-InstallerBuild.ps1 -SetupPatch",
      "detail": "Download base build artifacts for patch installers",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },

    // ==================== Git ====================
    {
      "label": "Git: Prune remote branches",
      "type": "shell",
      "command": "git fetch --prune",
      "detail": "Remove stale remote-tracking branches",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },

    // ==================== COPILOT Documentation ====================
    {
      "label": "COPILOT: Detect updates needed",
      "type": "shell",
      "command": "& { . ./Build/Agent/GitHelpers.ps1; $base = Get-DefaultBranchRef; python .github/detect_copilot_needed.py --base $base --strict }",
      "detail": "Check which COPILOT.md files need updates",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "COPILOT: Validate docs",
      "type": "shell",
      "command": "& { . ./Build/Agent/GitHelpers.ps1; $base = Get-DefaultBranchRef; python .github/check_copilot_docs.py --only-changed --base $base --fail }",
      "detail": "Validate COPILOT.md files for changed folders",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "COPILOT: Plan all folders",
      "type": "shell",
      "command": "& { . ./Build/Agent/GitHelpers.ps1; $base = Get-DefaultBranchRef; python .github/plan_copilot_updates.py --all --fallback-base $base --out .cache/copilot/diff-plan.json }",
      "detail": "Generate diff plan for all Src folders",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "COPILOT: Propose updates",
      "type": "shell",
      "command": "& { . ./Build/Agent/GitHelpers.ps1; $base = Get-DefaultBranchRef; python .github/scaffold_copilot_markdown.py --base $base }",
      "detail": "Generate COPILOT.md updates for changed folders (modifies files)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "COPILOT: Apply change-log",
      "type": "shell",
      "command": "python .github/copilot_apply_updates.py --plan .cache/copilot/diff-plan.json --folders ${input:copilotFolders}",
      "detail": "Apply auto change-log to selected folders (modifies files)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },

    // ==================== Agent/Container Management ====================
    // These require manual approval - resource intensive or destructive
    {
      "label": "Agents: Spin up",
      "type": "shell",
      "command": "./scripts/spin-up-agents.ps1 -RepoRoot '${workspaceFolder}' -Count ${input:agentCount}",
      "detail": "Create agent worktrees and containers (resource heavy)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "Agents: Build Docker image",
      "type": "shell",
      "command": "./scripts/docker-build-ipv4.ps1 -RegistryHosts @('mcr.microsoft.com') -BuildArgs @('-t','fw-build:ltsc2022','-f','Dockerfile.windows','${workspaceFolder}')",
      "detail": "Build fw-build:ltsc2022 container image (downloads GBs)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "Agents: Teardown containers",
      "type": "shell",
      "command": "./scripts/tear-down-agents.ps1 -RepoRoot '${workspaceFolder}'",
      "detail": "Stop and remove fw-agent-* containers (keeps worktrees)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "Agents: Teardown all",
      "type": "shell",
      "command": "./scripts/tear-down-agents.ps1 -RepoRoot '${workspaceFolder}' -RemoveWorktrees -RemoveNuGetVolume",
      "detail": "Remove containers, worktrees, and NuGet volume (destructive)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "Container: Test VS environment",
      "type": "shell",
      "command": ".\\scripts\\Agent\\Invoke-InContainer.ps1 -Script test-vsenv",
      "detail": "Verify VS build tools are available in container",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    }
  ]
}
