{
  // See https://go.microsoft.com/fwlink/?LinkId=733558
  // for the documentation about the tasks.json format
  // "$schema": "https://raw.githubusercontent.com/microsoft/vscode/master/resources/app/schemas/tasks.schema.json",
  "version": "2.0.0",
  "inputs": [
    {
      "id": "agentCount",
      "type": "promptString",
      "description": "Number of agents to spin up",
      "default": "3"
    },
    {
      "id": "copilotFolders",
      "type": "promptString",
      "description": "Space-separated Src/<Folder> entries to refresh",
      "default": "Src/Common"
    },
    {
      "id": "testTarget",
      "type": "promptString",
      "description": "MSBuild test target name (e.g., CacheLightTests, FwUtilsTests, allCsharp)",
      "default": "CacheLightTests"
    },
    {
      "id": "testProject",
      "type": "promptString",
      "description": "Path to test project (e.g., Src/CacheLight/CacheLightTests/CacheLightTests.csproj)",
      "default": "Src/CacheLight/CacheLightTests/CacheLightTests.csproj"
    }
  ],
  "tasks": [
    {
      "label": "Build Debug",
      "type": "shell",
      "command": "./build.ps1 -Configuration Debug",
      "group": {
        "kind": "build",
        "isDefault": true
      },
      "detail": "Build FieldWorks in Debug configuration using the traversal build",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Restore + Build Debug",
      "type": "shell",
      "command": "./build.ps1 -Configuration Debug",
      "group": "build",
      "detail": "Full restore and build for FieldWorks (required before running tests)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Whitespace check (CI parity)",
      "type": "shell",
      "command": "./Build/Agent/check-and-fix-whitespace.ps1",
      "detail": "Runs git log --check from nearest origin/release/* (or origin default), then runs the fixer to normalize whitespace.",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      }
    },
    {
      "label": "Commit messages check (CI parity)",
      "type": "shell",
      "command": "./Build/Agent/commit-messages.ps1",
      "detail": "Installs gitlint and lints commits since the nearest origin/release/* (or origin default).",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      }
    },
    {
      "label": "local CI check",
      "dependsOn": [
        "Commit messages check (CI parity)",
        "Whitespace check (CI parity)"
      ],
      "dependsOrder": "sequence",
      "detail": "Runs commit message lint and whitespace checks in the same order as CI"
    },
    // ==================== Test Tasks ====================
    {
      "label": "Test: Run C# tests (dotnet test)",
      "type": "shell",
      "command": "dotnet test ${input:testProject} -c Debug --no-build --settings Test.runsettings",
      "group": {
        "kind": "test",
        "isDefault": true
      },
      "detail": "Run C# tests using dotnet test (requires prior build)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Test: Build and Run MSBuild target (x86 MSBuild)",
      "type": "shell",
      "command": "& \"${env:ProgramFiles(x86)}\\Microsoft Visual Studio\\2022\\BuildTools\\MSBuild\\Current\\Bin\\MSBuild.exe\" Build/FieldWorks.targets /t:${input:testTarget} /p:Configuration=Debug /p:Platform=x64 /p:action=test",
      "group": "test",
      "detail": "Build and run tests using x86 MSBuild (avoids Clouseau BadImageFormatException)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Test: Run all C# tests (MSBuild)",
      "type": "shell",
      "command": "& \"${env:ProgramFiles(x86)}\\Microsoft Visual Studio\\2022\\BuildTools\\MSBuild\\Current\\Bin\\MSBuild.exe\" Build/FieldWorks.targets /t:allCsharp /p:Configuration=Debug /p:Platform=x64 /p:action=test",
      "group": "test",
      "detail": "Build and run ALL C# tests via x86 MSBuild (slow - runs everything)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    // ==================== Native C++ Test Tasks ====================
    // These require VS Developer Command Prompt environment (nmake, cl.exe)
    {
      "label": "Test: Build C++ TestGeneric (nmake)",
      "type": "shell",
      "command": "cmd /c \"call \"%ProgramFiles%\\Microsoft Visual Studio\\2022\\Community\\Common7\\Tools\\VsDevCmd.bat\" -arch=amd64 >nul 2>&1 && cd /d ${workspaceFolder}\\Src\\Generic\\Test && nmake /nologo BUILD_CONFIG=Debug BUILD_TYPE=d BUILD_ROOT=${workspaceFolder}\\ BUILD_ARCH=x64 /f testGenericLib.mak\"",
      "group": "test",
      "detail": "Build TestGeneric C++ tests using nmake (requires VS 2022)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Test: Build C++ TestViews (nmake)",
      "type": "shell",
      "command": "cmd /c \"call \"%ProgramFiles%\\Microsoft Visual Studio\\2022\\Community\\Common7\\Tools\\VsDevCmd.bat\" -arch=amd64 >nul 2>&1 && cd /d ${workspaceFolder}\\Src\\views\\Test && nmake /nologo BUILD_CONFIG=Debug BUILD_TYPE=d BUILD_ROOT=${workspaceFolder}\\ BUILD_ARCH=x64 /f testViews.mak\"",
      "group": "test",
      "detail": "Build TestViews C++ tests using nmake (requires VS 2022)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": "$msCompile"
    },
    {
      "label": "Test: Run C++ TestGeneric",
      "type": "shell",
      "command": "& { cd ${workspaceFolder}/Output/Debug; ./testGenericLib.exe }",
      "group": "test",
      "detail": "Run TestGeneric C++ tests (build first with 'Test: Build C++ TestGeneric')",
      "dependsOn": "Test: Build C++ TestGeneric (nmake)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "Test: Run C++ TestViews",
      "type": "shell",
      "command": "& { cd ${workspaceFolder}/Output/Debug; ./TestViews.exe }",
      "group": "test",
      "detail": "Run TestViews C++ tests (build first with 'Test: Build C++ TestViews')",
      "dependsOn": "Test: Build C++ TestViews (nmake)",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": ["-NoProfile", "-ExecutionPolicy", "Bypass", "-Command"]
        }
      },
      "problemMatcher": []
    },
    // ==================== Git Tasks ====================
    {
      "label": "git: prune remote branches",
      "type": "shell",
      "command": "git fetch --prune",
      "detail": "Remove stale remote-tracking branches that were deleted on the server.",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "COPILOT: Detect updates needed",
      "type": "shell",
      "command": "& { . ./Build/Agent/GitHelpers.ps1; $base = Get-DefaultBranchRef; python .github/detect_copilot_needed.py --base $base --strict }",
      "group": {
        "kind": "test",
        "isDefault": false
      },
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "COPILOT: Propose updates for changed folders",
      "type": "shell",
      "command": "& { . ./Build/Agent/GitHelpers.ps1; $base = Get-DefaultBranchRef; python .github/scaffold_copilot_markdown.py --base $base }",
      "group": "build",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "COPILOT: Validate COPILOT docs (changed only)",
      "type": "shell",
      "command": "& { . ./Build/Agent/GitHelpers.ps1; $base = Get-DefaultBranchRef; python .github/check_copilot_docs.py --only-changed --base $base --fail }",
      "group": {
        "kind": "test",
        "isDefault": false
      },
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "COPILOT: Validate instructions (lint)",
      "type": "shell",
      "command": "python scripts/tools/validate_instructions.py",
      "group": {
        "kind": "test",
        "isDefault": false
      },
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "COPILOT: Update flow (detect → propose → validate)",
      "dependsOn": [
        "COPILOT: Detect updates needed",
        "COPILOT: Propose updates for changed folders",
        "COPILOT: Validate COPILOT docs (changed only)"
      ],
      "dependsOrder": "sequence",
      "problemMatcher": [
        "$python"
      ]
    },
    {
      "label": "COPILOT: Plan all folders",
      "type": "shell",
      "command": "& { . ./Build/Agent/GitHelpers.ps1; $base = Get-DefaultBranchRef; python .github/plan_copilot_updates.py --all --fallback-base $base --out .cache/copilot/diff-plan.json }",
      "detail": "Scans every Src/** folder and writes .cache/copilot/diff-plan.json for Copilot usage.",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      }
    },
    {
      "label": "COPILOT: Apply auto change-log (subset)",
      "type": "shell",
      "command": "python .github/copilot_apply_updates.py --plan .cache/copilot/diff-plan.json --folders ${input:copilotFolders}",
      "detail": "Regenerates the auto change-log block inside the selected COPILOT.md folders.",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      }
    },
    {
      "label": "Agents: Spin up",
      "type": "shell",
      "command": "& { ./scripts/spin-up-agents.ps1 -RepoRoot \"${workspaceFolder}\" -Count ${input:agentCount}}",
      "detail": "Creates (or reuses) agent worktrees, containers, and VS Code windows.",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      }
    },
    {
      "label": "Agents: Build Docker image",
      "type": "shell",
      "command": "& { ./scripts/docker-build-ipv4.ps1 -RegistryHosts @('mcr.microsoft.com') -BuildArgs @('-t','fw-build:ltsc2022','-f','Dockerfile.windows','${workspaceFolder}') }",
      "detail": "Builds/refreshes the fw-build:ltsc2022 Windows container image used by agent worktrees.",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      }
    },
    {
      "label": "Agents: Teardown containers",
      "type": "shell",
      "command": "& { ./scripts/tear-down-agents.ps1 -RepoRoot \"${workspaceFolder}\" }",
      "detail": "Stops and removes all fw-agent-* containers but leaves worktrees intact.",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      }
    },
    {
      "label": "Agents: Teardown containers + worktrees",
      "type": "shell",
      "command": "& { ./scripts/tear-down-agents.ps1 -RepoRoot \"${workspaceFolder}\" -RemoveWorktrees -RemoveNuGetCaches }",
      "detail": "Stops containers and detaches/removes agent worktrees plus per-agent NuGet caches.",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      }
    },
    {
      "label": "Environment: Verify dependencies",
      "type": "shell",
      "command": ".\\Build\\Agent\\Verify-FwDependencies.ps1 -IncludeOptional",
      "detail": "Checks that all required build dependencies are available (VS, MSBuild, .NET, WiX, etc.)",
      "group": {
        "kind": "test",
        "isDefault": false
      },
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "Environment: Setup build environment",
      "type": "shell",
      "command": ".\\Build\\Agent\\Setup-FwBuildEnv.ps1 -Verify",
      "detail": "Configures VS/MSBuild environment variables for the current session",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "Environment: Setup Serena MCP",
      "type": "shell",
      "command": ".\\Build\\Agent\\Setup-Serena.ps1",
      "detail": "Verifies Serena MCP configuration and language server availability",
      "options": {
        "shell": {
          "executable": "powershell.exe",
          "args": [
            "-NoProfile",
            "-ExecutionPolicy",
            "Bypass",
            "-Command"
          ]
        }
      },
      "problemMatcher": []
    },
    {
      "label": "Environment: Full verification",
      "dependsOn": [
        "Environment: Verify dependencies",
        "Environment: Setup build environment",
        "Environment: Setup Serena MCP"
      ],
      "dependsOrder": "sequence",
      "detail": "Runs all environment verification steps in order"
    }
  ]
}