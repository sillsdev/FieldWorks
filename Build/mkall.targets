<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="Current">
	<!--
		Native C++ Build Orchestration for FieldWorks

		This file coordinates building native C++ components (DebugProcs, GenericLib, FwKernel, Views)
		and their associated test executables. It is called by the MSBuild Traversal SDK via FieldWorks.proj.

		Modern Build Path (MSBuild Traversal SDK):
		  FieldWorks.proj → Build/Src/NativeBuild/NativeBuild.csproj → This file

		Responsibilities:
		1. Native C++ component builds (DebugProcs, GenericLib, FwKernel, Views)
		2. Dependency management (NuGet packages, external artifacts)
		3. Code generation (CellarConstants)
		4. Clean/utility targets

		Key Targets:
		  - allCppNoTest: Build core native components (used by traversal SDK)
		  - Individual targets: DebugProcs, GenericLib, FwKernel, Views, etc.

		Note: PDB files are now handled by the SDK automatically.
		      Symbol package downloads have been removed.
	-->
	<!-- ======================================================================================== -->
	<!-- Main Native Build Target (Called by Traversal SDK)                                      -->
	<!-- ======================================================================================== -->
	<Target Name="allCppNoTest" DependsOnTargets="DebugProcs;GenericLib;FwKernel;Views" />
	<ItemGroup>
		<Fragments Include="$(dir-fwdistfiles)/*.fragment.manifest" />
	</ItemGroup>
	<ItemGroup>
		<!-- CLSIDs implemented in managed code that must be excluded from native manifests to avoid SxS duplicates -->
		<ExcludedClsids Include="{17a2e876-2968-11e0-8046-0019dbf4566e}" /> <!-- ManagedPictureFactory -->
		<ExcludedClsids Include="{97199458-10C7-49da-B3AE-EA922EA64859}" /> <!-- VwDrawRootBuffered -->
		<ExcludedClsids Include="{3fb0fcd2-ac55-42a8-b580-73b89a2b6215}" /> <!-- ManagedVwWindow -->
		<ExcludedClsids Include="{e771361c-ff54-4120-9525-98a0b7a9accf}" /> <!-- ManagedLgIcuCollator -->
		<ExcludedClsids Include="{830BAF1F-6F84-46EF-B63E-3C1BFDF9E83E}" /> <!-- ViewInputManager -->
	</ItemGroup>
	<Target
		Name="regFreeCpp"
		DependsOnTargets="FwKernel;Views"
		AfterTargets="FwKernel;Views"
		Condition="'$(OS)'=='Windows_NT'"
	>
		<ItemGroup>
			<RegFreeDlls Include="$(dir-fwoutputCommon)\FwKernelTlb.tlb">
				<Server>FwKernel.dll</Server>
			</RegFreeDlls>
			<RegFreeDlls Include="$(dir-outputBase)\Views.dll" />
		</ItemGroup>
		<RegFree
			Executable="$(dir-outputBase)/FwKernel.dll"
			Output="$(dir-outputBase)/FieldWorks.Tests.manifest"
			Dlls="@(RegFreeDlls)"
			Fragments="@(Fragments)"
			Platform="$(Platform)"
			MSBuildArchitecture="$(Platform)"
			ExcludedClsids="@(ExcludedClsids)"
		/>
	</Target>
	<Target Name="DebugProcs" DependsOnTargets="initWindows;CopyDlls">
		<Make
			Condition="'$(OS)'=='Windows_NT'"
			Makefile="$(fwrt)\Src\DebugProcs\DebugProcs.mak"
			Configuration="$(config-capital)"
			BuildRoot="$(fwrt)"
			BuildArch="x64"
			WorkingDirectory="$(fwrt)\Src\DebugProcs"
		/>
		<Message Text="Finished building DebugProcs." />
	</Target>
	<Target Name="GenericLib" DependsOnTargets="DebugProcs">
		<Make
			Condition="'$(OS)'=='Windows_NT'"
			Makefile="$(fwrt)\Src\Generic\GenericLib.mak"
			Configuration="$(config-capital)"
			BuildRoot="$(fwrt)"
			BuildArch="x64"
			WorkingDirectory="$(fwrt)\Src\Generic"
		/>
		<Message Text="Finished building GenericLib." />
	</Target>
	<Target
		Name="FwKernel"
		DependsOnTargets="GenericLib;GenerateCellarConstants;AppCore;CopyDlls"
	>
		<Message Text="FwKernel make-target='$(make-target)'" />
		<Make
			Condition="'$(OS)'=='Windows_NT'"
			Makefile="$(fwrt)\Src\Kernel\FwKernel.mak"
			Configuration="$(config-capital)"
			BuildRoot="$(fwrt)"
			BuildArch="x64"
			WorkingDirectory="$(fwrt)\Src\Kernel"
		/>
		<!-- Create stub manifest if needed -->
		<WriteLinesToFile
			File="$(dir-outputBase)\FwKernel.X.manifest"
			Lines="&lt;assembly xmlns=&quot;urn:schemas-microsoft-com:asm.v1&quot; manifestVersion=&quot;1.0&quot;&gt;&lt;/assembly&gt;"
			Overwrite="false"
			Condition="'$(OS)'=='Windows_NT' AND !Exists('$(dir-outputBase)\FwKernel.X.manifest')"
		/>

		<ItemGroup>
			<FwKernelTlb Include="$(dir-fwoutputCommon)\FwKernelTlb.tlb">
				<Server>FwKernel.dll</Server>
			</FwKernelTlb>
		</ItemGroup>

		<!-- Generate manifest with explicit x64 platform -->
		<RegFree
			Executable="$(dir-outputBase)\FwKernel.dll"
			Output="$(dir-outputBase)\FwKernel.X.manifest"
			Dlls="@(FwKernelTlb)"
			Platform="x64"
			Condition="'$(OS)'=='Windows_NT'"
			ExcludedClsids="@(ExcludedClsids)"
		/>
		<Message Text="Finished building FwKernel." />
	</Target>
	<Target Name="AppCore" DependsOnTargets="DebugProcs;GenericLib">
		<Message Text="AppCore make-target='$(make-target)'" />
		<Message Text="Finished building AppCore." />
	</Target>
	<Target Name="Views" DependsOnTargets="GenericLib;FwKernel;GenerateCellarConstants">
		<Make
			Condition="'$(OS)'=='Windows_NT'"
			Makefile="$(fwrt)\Src\views\Views.mak"
			Configuration="$(config-capital)"
			BuildRoot="$(fwrt)"
			BuildArch="x64"
			WorkingDirectory="$(fwrt)\Src\views"
		/>
		<Message
			Text="Generating Views.X.manifest for 64-bit registration-free COM..."
			Importance="high"
		/>
		<!-- Create stub manifest if it doesn't exist (RegFree will populate it) -->
		<WriteLinesToFile
			File="$(dir-outputBase)\Views.X.manifest"
			Lines="&lt;assembly xmlns=&quot;urn:schemas-microsoft-com:asm.v1&quot; manifestVersion=&quot;1.0&quot;&gt;&lt;/assembly&gt;"
			Overwrite="false"
			Condition="'$(OS)'=='Windows_NT' AND !Exists('$(dir-outputBase)\Views.X.manifest')"
		/>
		<!-- Generate full manifest with COM entries - fail fast on errors -->
		<RegFree
			Executable="$(dir-outputBase)\Views.dll"
			Output="$(dir-outputBase)\Views.X.manifest"
			Platform="x64"
			Condition="'$(OS)'=='Windows_NT'"
			ExcludedClsids="@(ExcludedClsids)"
		/>
		<!-- Validate manifest was created successfully -->
		<Error
			Text="Views.X.manifest not generated - registration-free COM will fail"
			Condition="'$(OS)'=='Windows_NT' AND !Exists('$(dir-outputBase)\Views.X.manifest')"
		/>
		<Message Text="Finished building Views." />
	</Target>
	<UsingTask
		TaskName="LcmGenerate"
		AssemblyFile="$(LcmBuildTasksDir)/SIL.LCModel.Build.Tasks.dll"
	/>
	<ItemGroup>
		<CellarConstantsInputs Include="$(LcmModelArtifactsDir)/MasterLCModel.xml" />
		<CellarConstantsInputs Include="$(fwrt)/Src/Kernel/CellarConstants.vm.h" />
		<CellarConstantsOutputs Include="$(fwrt)/Output/Common/CellarConstants.h" />
	</ItemGroup>
	<Target
		Name="GenerateCellarConstants"
		DependsOnTargets="CopyCellarBaseConstants;CopyDlls"
		Inputs="@(CellarConstantsInputs)"
		Outputs="@(CellarConstantsOutputs)"
	>
		<MakeDir Directories="$(dir-fwoutputCommon)" Condition="'$(action)'!='clean'" />
		<LcmGenerate
			XmlFile="$(LcmModelArtifactsDir)/MasterLCModel.xml"
			OutputDir="$(dir-fwoutputCommon)"
			OutputFile="CellarConstants.h"
			TemplateFile="$(fwrt)/Src/Kernel/CellarConstants.vm.h"
			WorkingDirectory="$(LcmModelArtifactsDir)/"
			Condition="'$(action)'!='clean'"
		/>
	</Target>
	<Target
		Name="CopyCellarBaseConstants"
		Inputs="$(fwrt)/Src/Kernel/CellarBaseConstants.h"
		Outputs="$(fwrt)/Output/Common/CellarBaseConstants.h"
	>
		<MakeDir Directories="$(dir-fwoutputCommon)" Condition="'$(action)'!='clean'" />
		<Copy
			SourceFiles="$(fwrt)/Src/Kernel/CellarBaseConstants.h"
			DestinationFolder="$(fwrt)/Output/Common"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
			Condition="'$(action)'!='clean'"
		/>
	</Target>
	<PropertyGroup>
		<Original-OBJ_DIR>$(OBJ_DIR)</Original-OBJ_DIR>
		<Original-BUILD4UX>$(BUILD4UX)</Original-BUILD4UX>
		<Original-ANAL_TYPE>$(ANAL_TYPE)</Original-ANAL_TYPE>
	</PropertyGroup>
	<Target
		Name="remakefw-internal"
		DependsOnTargets="CleanAll;Initialize;CopyDlls;setRegistryValues;GeneratePartsAndLayoutFiles;mkall"
	/>
	<ItemGroup>
		<!-- Don't delete FieldWorks.targets - that has to be done separately, otherwise we
		delete the file we just create previously when we run remakefw -->
		<!--<GeneratedFiles Include="$(fwrt)/Build/FieldWorks.targets"/>-->
		<GeneratedFiles Include="$(fwrt)/Src/**/Collection.cpp" />
		<GeneratedFiles Include="$(fwrt)/Src/**/asserts.log" />
		<GeneratedFiles Include="$(fwrt)/Src/Common/ViewsInterfaces/Views.cs" />
		<GeneratedFiles Include="$(fwrt)/Lib/debug/unit++.lib" />
		<GeneratedFiles Include="$(fwrt)/Lib/release/unit++.lib" />
		<GeneratedFiles Include="$(fwrt)/DistFiles/Parts/GeneratedParts.xml" />
		<GeneratedFiles Include="$(fwrt)/DistFiles/Parts/Generated.fwlayout" />
	</ItemGroup>
	<Target Name="CleanDownloads">
		<ForceDelete Files="$(DownloadsDir)" />
	</Target>
	<Target Name="Clean" DependsOnTargets="CleanAll">
		<ForceDelete Files="$(fwrt)/Build/FieldWorks.targets" />
	</Target>
	<Target Name="CleanAll" DependsOnTargets="cleanWindows">
		<!-- remove the Obj and Output directories -->
		<ForceDelete Files="$(dir-fwobj);$(dir-fwoutput)" />
		<!-- remove other directories and files created during the build process -->
		<ForceDelete Files="@(GeneratedFiles)" />
		<!-- remove LCM files -->
		<ItemGroup>
			<LcmFilesToDelete Include="$(fwrt)/Src/Kernel/*.idh" />
			<LcmFilesToDelete Include="$(fwrt)/Src/Kernel/FwKernelTlb.idl" />
			<LcmFilesToDelete Include="$(fwrt)/DistFiles/Styles.dtd" />
			<LcmFilesToDelete Include="$(fwrt)/DistFiles/Templates/GOLDEtic.xml" />
			<LcmFilesToDelete Include="$(fwrt)/DistFiles/Templates/NewLangProj.fwdata" />
			<LcmFilesToDelete Include="$(fwrt)/DistFiles/Templates/POS.xml" />
			<LcmFilesToDelete Include="$(fwrt)/DistFiles/Templates/SemDom.xml" />
			<LcmFilesToDelete Include="$(dir-fwoutputCommon)/FwKernelTlb.json" />
		</ItemGroup>
		<ForceDelete Files="@(LcmFilesToDelete)" />
		<ForceDelete Files="$(fwrt)/DistFiles/Icu$(IcuVersion)" />
		<Message Text="Finished deleting the output directories!" />
	</Target>
	<PropertyGroup>
		<MasterVersionInfo>$(fwrt)/Src/MasterVersionInfo.txt</MasterVersionInfo>
		<TeamCityUrl>https://build.palaso.org/</TeamCityUrl>

		<!-- Versions of NuGet packages. These need to match the versions in nuget-common/packages.config -->
		<ChorusNugetVersion>6.0.0-beta0063</ChorusNugetVersion>
		<PalasoNugetVersion>17.0.0-beta0089</PalasoNugetVersion>
		<ParatextNugetVersion>9.4.0.1-beta</ParatextNugetVersion>
		<LcmNugetVersion>11.0.0-beta0148</LcmNugetVersion>
		<IcuNugetVersion>70.1.123</IcuNugetVersion>
		<HermitCrabNugetVersion>3.7.4</HermitCrabNugetVersion>
		<IPCFrameworkVersion>1.1.1-beta0001</IPCFrameworkVersion>
		<!-- bt393 is the master branch build of ExCss for Windows development. Update when appropriate. -->
		<ExCssBuildType Condition="'$(OS)'=='Windows_NT'">bt393</ExCssBuildType>
		<ExCss Condition="'$(OS)'=='Windows_NT'">ExCss</ExCss>
		<ExCssBuildTag>.lastSuccessful</ExCssBuildTag>
		<GeckoFxHtmlToPdfBuildType Condition="'$(OS)'=='Windows_NT' AND '$(Platform)'!='x64'"
			>GeckofxHtmlToPdf_GeckofxHtmlToPdfGeckofx60Win32continuous</GeckoFxHtmlToPdfBuildType
		>
		<GeckoFxHtmlToPdfBuildType Condition="'$(OS)'=='Windows_NT' AND '$(Platform)'=='x64'"
			>GeckofxHtmlToPdf_Win64_continuous</GeckoFxHtmlToPdfBuildType
		>
		<GeckoFxHtmlToPdfBuildTag>.lastSuccessful</GeckoFxHtmlToPdfBuildTag>
		<!-- Versions of NuGet packages. Keep these in sync with PackageReference versions in the managed projects. -->
		<ChorusNugetVersion>6.0.0-beta0063</ChorusNugetVersion>
		<PalasoNugetVersion>17.0.0-beta0080</PalasoNugetVersion>
		<ParatextNugetVersion>9.4.0.1-beta</ParatextNugetVersion>
		<LcmNugetVersion>11.0.0-beta0145</LcmNugetVersion>
		<IcuNugetVersion>70.1.152</IcuNugetVersion>
		<HermitCrabNugetVersion>3.7.4</HermitCrabNugetVersion>
		<IPCFrameworkVersion>1.1.1-beta0001</IPCFrameworkVersion>
		<DownloadsDir>$(fwrt)/Downloads</DownloadsDir>
		<PackagesDir>$(fwrt)/packages</PackagesDir>
	</PropertyGroup>
	<ItemGroup>
		<!-- NOTE: Most managed DLLs are now handled automatically by PackageReference.
		     Only native dependencies and special cases remain here. -->
		<!-- Native Keyman interop DLLs (from KeymanLegacyBundle package) -->
		<PalasoFiles Include="Keyman10Interop.dll" Condition="'$(OS)'=='Windows_NT'" />
		<PalasoFiles Include="Keyman7Interop.dll" Condition="'$(OS)'=='Windows_NT'" />
		<PalasoFiles Include="KeymanLink.dll" Condition="'$(OS)'=='Windows_NT'" />
		<!-- Platform-specific irrKlang native DLL (from SIL.Media package contentFiles) -->
		<PalasoFiles
			Include="lib/win-x86/irrKlang.NET4.dll"
			Condition="'$(OS)'=='Windows_NT' AND '$(Platform)'!='x64'"
		/>
		<PalasoFiles
			Include="lib/win-x64/irrKlang.NET4.dll"
			Condition="'$(OS)'=='Windows_NT' AND '$(Platform)'=='x64'"
		/>
		<!-- Platform-specific Interop.WIA.dll (from SIL.Windows.Forms package) -->
		<PalasoFiles Include="Interop.WIA.dll" />
		<!-- NDesk.DBus.dll.config file (config files not auto-copied by NuGet) -->
		<PalasoFiles Include="NDesk.DBus.dll.config" />
		<!-- Chorus.exe application (entry point, not just a library) -->
		<ChorusFiles Include="Chorus.exe" />
		<!-- ICU native binaries and static libraries -->
		<IcuFiles Include="gennorm2.exe" />
		<IcuFiles Include="icudt$(IcuVersion).dll" />
		<IcuFiles Include="icuin$(IcuVersion).dll" />
		<IcuFiles Include="icutu$(IcuVersion).dll" />
		<IcuFiles Include="icuuc$(IcuVersion).dll" />
		<IcuFiles Include="icudt.lib" />
		<IcuFiles Include="icuin.lib" />
		<IcuFiles Include="icuuc.lib" />
		<!-- LCM data files and headers (contentFiles from SIL.LCModel packages) -->
		<LcmOutputCommonFiles Include="KernelInterfaces/FwKernelTlb.json" />
		<LcmFwKernelFiles Include="KernelInterfaces/common.idh" />
		<LcmFwKernelFiles Include="KernelInterfaces/FwKernel.idh" />
		<LcmFwKernelFiles Include="KernelInterfaces/Language.idh" />
		<LcmFwKernelFiles Include="KernelInterfaces/TextServ.idh" />
		<LcmFwKernelFiles Include="KernelInterfaces/FwKernelTlb.idl" />
		<LcmDistFiles Include="Styles.dtd" />
		<!-- GOLDEtic.xml is copied so that developers can use grammatical categories without building localizations.
			Building localizations will overwrite this file with the latest translations. -->
		<LcmTemplatesFiles Include="Templates/GOLDEtic.xml" />
		<LcmTemplatesFiles Include="Templates/NewLangProj.fwdata" />
		<LcmTemplatesFiles Include="Templates/POS.xml" />
		<LcmTemplatesFiles Include="Templates/SemDom.xml" />
		<LcmIcuDataFiles Include="IcuData/data/nfc.txt" />
		<LcmIcuDataFiles Include="IcuData/data/nfcHebrew.txt" />
		<LcmIcuDataFiles Include="IcuData/data/nfcOverrides.txt" />
		<LcmIcuDataFiles Include="IcuData/data/nfkc.txt" />
		<LcmIcuDataFiles Include="IcuData/data/nfkcOverrides.txt" />
		<LcmIcuDataFiles Include="IcuData/data/UnicodeDataOverrides.txt" />
		<LcmIcuNrmFiles Include="IcuData/icudt$(IcuVersion)l/nfc_fw.nrm" />
		<LcmIcuNrmFiles Include="IcuData/icudt$(IcuVersion)l/nfkc_fw.nrm" />
		<LcmMissingFiles Include="SIL.LCModel.dll.config" />
	</ItemGroup>
	<!-- Restore NuGet packages for SDK-style projects -->
	<Target Name="RestorePackages">
		<Message Text="Restoring NuGet packages with dotnet restore..." />
		<Exec
			Command="dotnet restore &quot;$(fwrt)\FieldWorks.sln&quot; --packages &quot;$(PackagesDir)&quot;"
			ContinueOnError="false"
		/>
	</Target>
	<Target
		Name="downloadDlls"
		DependsOnTargets="RestorePackages;DefineNugetPackages"
		Condition="'$(disableDownloads)'!='true'"
	>
		<MakeDir Directories="$(DownloadsDir)" />
		<MakeDir Directories="$(DownloadsDir)/lib" />
		<MakeDir Directories="$(DownloadsDir)/lib/x64" />
		<MakeDir Directories="$(DownloadsDir)/lib/x86" />
		<!-- Collect NuGet package files (must be done after DefineNugetPackages dependency) -->
		<ItemGroup>
			<SILNugetFiles Include="$(PackagesDir)/$([System.String]::new('%(SILNugetPackages.Identity)').ToLower())/%(SILNugetPackages.Version)/%(SILNugetPackages.Path)" />
		</ItemGroup>
		<!-- TODO (Hasso) 2011.11: copy on Condition="'$(UseLocalLibraries)'!='Y'" -->
		<Message Text="Copying artifacts from Palaso, Chorus, LCM, and related packages to Downloads." />
		<Copy
			SourceFiles="@(SILNugetFiles)"
			DestinationFolder="$(DownloadsDir)/%(RecursiveDir)"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<Message
			Text="(Palaso, Chorus, and LCM artifacts will be copied to Output from $(PalasoArtifactsDir), $(ChorusArtifactsDir), and $(LcmArtifactsDir), respectively, as  specified in LibraryDevelopment.targets)"
			Condition="'$(UseLocalLibraries)'=='Y'"
		/>
		<Message
			Text="Downloading artifacts for $(ExCss)."
			Condition="'$(OS)'=='Windows_NT' AND '$(TeamCityUrl)'!=''"
		/>
		<DownloadFilesFromTeamCity
			Address="$(TeamCityUrl)"
			BuildType="$(ExCssBuildType)"
			Tag="$(ExCssBuildTag)"
			Artifacts="$(ExCss).dll"
			DownloadsDir="$(DownloadsDir)"
			Condition="'$(OS)'=='Windows_NT' AND '$(TeamCityUrl)'!=''"
		/>
		<Message
			Text="Downloading artifacts for geckofxHtmlToPdf."
			Condition="'$(OS)'=='Windows_NT' AND '$(TeamCityUrl)'!=''"
		/>
		<DownloadFilesFromTeamCity
			Address="$(TeamCityUrl)"
			BuildType="$(GeckoFxHtmlToPdfBuildType)"
			Tag="$(GeckoFxHtmlToPdfBuildTag)"
			Artifacts="GeckofxHtmlToPdf.exe;GeckofxHtmlToPdf.exe.config;Args.dll"
			DownloadsDir="$(DownloadsDir)"
			Condition="'$(OS)'=='Windows_NT' AND '$(TeamCityUrl)'!=''"
		/>
		<Message
			Text="Using pre-populated downloads directory for ExCss and GeckofxHtmlToPdf artifacts."
			Condition="'$(TeamCityUrl)'==''"
		/>
		<Error
			Text="GeckofxHtmlToPdf.exe not found - PDF export will not work. Build from https://github.com/sillsdev/geckofxHtmlToPdf and place output in Downloads directory."
			Condition="!Exists('$(DownloadsDir)/GeckofxHtmlToPdf.exe')"
		/>
	</Target>
	<Target Name="DefineNugetPackages">
		<ItemGroup>
			<!-- NOTE: Most managed DLLs are now handled automatically by PackageReference in .csproj files.
			     This section now only handles native dependencies and special cases that require manual copying. -->
			<!-- ICU native binaries: x64 only for 64-bit builds -->
			<SILNugetPackages
				Include="Icu4c.Win.Fw.Bin"
				Condition="'$(OS)'=='Windows_NT' AND '$(Platform)'=='x64'"
			>
				<Version>$(IcuNugetVersion)</Version>
				<Path>build/win-x64/*.*</Path>
			</SILNugetPackages>
			<!-- ICU DLLs: x64 runtime files -->
			<SILNugetPackages
				Include="Icu4c.Win.Fw.Lib"
				Condition="'$(OS)'=='Windows_NT' AND '$(Platform)'=='x64'"
			>
				<Version>$(IcuNugetVersion)</Version>
				<Path>runtimes/win7-x64/native/*.*</Path>
			</SILNugetPackages>
			<!-- ICU static libraries: x64 lib files for linking -->
			<SILNugetPackages Include="Icu4c.Win.Fw.Lib" Condition="'$(Platform)'=='x64'">
				<Version>$(IcuNugetVersion)</Version>
				<Path>build/native/lib/win7-x64/*.*</Path>
			</SILNugetPackages>
			<!-- ICU headers: platform-independent -->
			<SILNugetPackages Include="Icu4c.Win.Fw.Lib">
				<Version>$(IcuNugetVersion)</Version>
				<Path>build/native/include/**/*.*</Path>
			</SILNugetPackages>
			<!-- IPCFramework DLL (may be needed for FLExBridge communication) -->
			<SILNugetPackages Include="SIL.FLExBridge.IPCFramework">
				<Version>$(IPCFrameworkVersion)</Version>
				<Path>lib/net461/*.*</Path>
			</SILNugetPackages>
			<!-- LCM contentFiles (data files, headers, build tasks) that aren't auto-deployed -->
			<SILNugetPackages Include="SIL.LCModel">
				<Version>$(LcmNugetVersion)</Version>
				<Path>contentFiles/any/any/*.*</Path>
			</SILNugetPackages>
			<SILNugetPackages Include="SIL.LCModel.Build.Tasks">
				<Version>$(LcmNugetVersion)</Version>
				<Path>tools/net462/*.*</Path>
			</SILNugetPackages>
			<!-- Copy contentFiles with explicit patterns to preserve directory structure -->
			<SILNugetPackages Include="SIL.LCModel.Core">
				<Version>$(LcmNugetVersion)</Version>
				<Path>contentFiles/any/any/*.*</Path>
			</SILNugetPackages>
			<SILNugetPackages Include="SIL.LCModel.Core">
				<Version>$(LcmNugetVersion)</Version>
				<Path>contentFiles/KernelInterfaces/*.*</Path>
			</SILNugetPackages>
			<SILNugetPackages Include="SIL.LCModel.Core">
				<Version>$(LcmNugetVersion)</Version>
				<Path>contentFiles/IcuData/data/*.*</Path>
			</SILNugetPackages>
			<SILNugetPackages Include="SIL.LCModel.Core">
				<Version>$(LcmNugetVersion)</Version>
				<Path>contentFiles/IcuData/icudt70l/*.*</Path>
			</SILNugetPackages>
			<!-- Palaso contentFiles (irrKlang, Keyman interop, platform-specific files) -->
			<SILNugetPackages Include="SIL.Media">
				<Version>$(PalasoNugetVersion)</Version>
				<Path>build/**/*.*</Path>
			</SILNugetPackages>
			<SILNugetPackages Include="SIL.Media">
				<Version>$(PalasoNugetVersion)</Version>
				<Path>contentFiles/any/any/*.*</Path>
			</SILNugetPackages>
			<SILNugetPackages Include="SIL.Archiving">
				<Version>$(PalasoNugetVersion)</Version>
				<Path>contentFiles/any/any/*.*</Path>
			</SILNugetPackages>
			<SILNugetPackages Include="SIL.Windows.Forms" Condition="'$(Platform)'!='x64'">
				<Version>$(PalasoNugetVersion)</Version>
				<Path>build/Interop.WIA.dll</Path>
			</SILNugetPackages>
			<SILNugetPackages Include="SIL.Windows.Forms" Condition="'$(Platform)'=='x64'">
				<Version>$(PalasoNugetVersion)</Version>
				<Path>build/x64/Interop.WIA.dll</Path>
			</SILNugetPackages>
			<SILNugetPackages Include="SIL.Windows.Forms.Archiving">
				<Version>$(PalasoNugetVersion)</Version>
				<Path>contentFiles/any/any/*.*</Path>
			</SILNugetPackages>
			<SILNugetPackages Include="SIL.Windows.Forms.Keyboarding">
				<Version>$(PalasoNugetVersion)</Version>
				<Path>build/*.*</Path>
			</SILNugetPackages>
			<SILNugetPackages Include="SIL.Windows.Forms.Keyboarding">
				<Version>$(PalasoNugetVersion)</Version>
				<Path>contentFiles/any/any/*.*</Path>
			</SILNugetPackages>
			<!-- Enchant.Net contentFiles (native spell-checking binaries) -->
			<SILNugetPackages Include="Enchant.Net">
				<Version>1.4.3-beta0010</Version>
				<Path>contentFiles/any/any/*.*</Path>
			</SILNugetPackages>
			<!-- KeymanLegacyBundle (native interop DLLs) -->
			<SILNugetPackages Include="KeymanLegacyBundle">
				<Version>1.0.0</Version>
				<Path>lib/*.*</Path>
			</SILNugetPackages>
			<!-- Chorus.App (contains Chorus.exe, an application entry point) -->
			<SILNugetPackages Include="SIL.Chorus.App">
				<Version>$(ChorusNugetVersion)</Version>
				<Path>lib/net462/*.*</Path>
			</SILNugetPackages>
			<!-- SIL.BuildTasks is now a PackageReference in FwBuildTasks.csproj -->
		</ItemGroup>
	</Target>
	<!-- Setup source variables (to enable local development in libpalaso, chorus, and liblcm) -->
	<PropertyGroup>
		<PalasoArtifactsDir Condition="'$(PalasoArtifactsDir)'==''"
			>$(DownloadsDir)</PalasoArtifactsDir
		>
		<ChorusArtifactsDir Condition="'$(ChorusArtifactsDir)'==''"
			>$(DownloadsDir)</ChorusArtifactsDir
		>
		<!-- LCM Core artifacts (native interfaces, ICU data) from sil.lcmodel.core NuGet package -->
		<LcmArtifactsDir Condition="'$(LcmArtifactsDir)'=='' AND '$(PkgSIL_LCModel_Core)'!=''"
			>$(PkgSIL_LCModel_Core)/contentFiles</LcmArtifactsDir
		>
		<LcmArtifactsDir Condition="'$(LcmArtifactsDir)'==''"
			>$(PackagesDir)/sil.lcmodel.core/$(LcmNugetVersion)/contentFiles</LcmArtifactsDir
		>
		<!-- LCM Model artifacts (MasterLCModel.xml, Styles.dtd, templates) from sil.lcmodel NuGet package -->
		<LcmModelArtifactsDir Condition="'$(LcmModelArtifactsDir)'==''"
			>$(PackagesDir)/sil.lcmodel/$(LcmNugetVersion)/contentFiles</LcmModelArtifactsDir
		>
		<!-- LCM Build Tasks DLL from separate package -->
		<LcmBuildTasksDir Condition="'$(LcmBuildTasksDir)'==''"
			>$(PackagesDir)/sil.lcmodel.build.tasks/$(LcmNugetVersion)/tools/net462</LcmBuildTasksDir
		>
	</PropertyGroup>
	<!-- item group for downloads, to allow easy copying -->
	<!-- wildcards don't work unless the files have already been downloaded once -->
	<ItemGroup>
		<!-- we need to explicitly specify the important files, otherwise they'll be ignored
		if they don't exist by the time this ItemGroup is read -->
		<DownloadedFiles Include="$(DownloadsDir)/IPCFramework.dll" />
		<DownloadedFiles
			Include="$(DownloadsDir)/Args.dll"
			Condition="Exists('$(DownloadsDir)/Args.dll')"
		/>
		<DownloadedFiles
			Include="$(DownloadsDir)/ExCss.dll"
			Condition="Exists('$(DownloadsDir)/ExCss.dll')"
		/>
		<DownloadedFiles
			Include="$(DownloadsDir)/ExCSS.dll"
			Condition="Exists('$(DownloadsDir)/ExCSS.dll')"
		/>
		<!-- PDB files for ExCss are now handled by SDK, no longer copied manually -->
		<DownloadedFiles Include="$(DownloadsDir)/Sandwych.Quickgraph.Core.dll" />
		<DownloadedFiles Include="$(DownloadsDir)/SIL.Machine.dll" />
		<DownloadedFiles Include="$(DownloadsDir)/SIL.Machine.Morphology.HermitCrab.dll" />
	</ItemGroup>
	<Target Name="CopyDlls" DependsOnTargets="downloadDlls;copyLibL10ns">
		<!-- .Net assemblies -->
		<Copy
			SourceFiles="$(fwrt)/DistFiles/LinqBridge.dll"
			DestinationFolder="$(dir-outputBase)"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<Copy
			SourceFiles="$(fwrt)/DistFiles/log4net.dll"
			DestinationFolder="$(dir-outputBase)"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<Copy
			SourceFiles="$(fwrt)/Lib/Common/Interop.ResourceDriver.dll"
			DestinationFolder="$(dir-outputBase)"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<!-- Windows dynamically loaded libraries (x64 only) -->
		<Copy
			SourceFiles="$(fwrt)/DistFiles/xample64.dll"
			DestinationFiles="$(dir-outputBase)/xample.dll"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
			Condition="'$(OS)'=='Windows_NT'"
		/>
		<!-- ICU libs - copy directly from NuGet packages (x64 only) -->
		<Copy
			SourceFiles="$(PackagesDir)/icu4c.win.fw.lib/$(IcuNugetVersion)/build/native/lib/win7-x64/icudt.lib"
			DestinationFolder="$(fwrt)/Lib"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
			Condition="'$(OS)'=='Windows_NT'"
		/>
		<Copy
			SourceFiles="$(PackagesDir)/icu4c.win.fw.lib/$(IcuNugetVersion)/build/native/lib/win7-x64/icuin.lib"
			DestinationFolder="$(fwrt)/Lib"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
			Condition="'$(OS)'=='Windows_NT'"
		/>
		<Copy
			SourceFiles="$(PackagesDir)/icu4c.win.fw.lib/$(IcuNugetVersion)/build/native/lib/win7-x64/icuuc.lib"
			DestinationFolder="$(fwrt)/Lib"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
			Condition="'$(OS)'=='Windows_NT'"
		/>
		<!-- ICU headers - copy directly from NuGet package -->
		<ItemGroup>
			<IcuHeaders Include="$(PackagesDir)/icu4c.win.fw.lib/$(IcuNugetVersion)/build/native/include/unicode/*.h" />
		</ItemGroup>
		<!-- ICU sources -->
		<Copy
			Sourcefiles="@(IcuHeaders)"
			DestinationFolder="$(fwrt)/Include/unicode"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<!-- Copy ICU dll's and exe's to lib/x64 and lib/x86 - copy directly from NuGet packages -->
		<ItemGroup>
			<IcuFileSet32 Include="$(PackagesDir)/icu4c.win.fw.lib/$(IcuNugetVersion)/runtimes/win7-x86/native/icu*.dll" />
			<IcuFileSet32 Include="$(PackagesDir)/icu4c.win.fw.bin/$(IcuNugetVersion)/build/win-x86/gennorm2.exe" />
		</ItemGroup>
		<ItemGroup>
			<IcuFileSet64 Include="$(PackagesDir)/icu4c.win.fw.lib/$(IcuNugetVersion)/runtimes/win7-x64/native/icu*.dll" />
			<IcuFileSet64 Include="$(PackagesDir)/icu4c.win.fw.bin/$(IcuNugetVersion)/build/win-x64/gennorm2.exe" />
		</ItemGroup>
		<!-- Include 32-bit ICU, even if arch is x64, so we can provide 32-bit ICU for 32-bit Paratext to use when the tools interact. -->
		<Copy
			SourceFiles="@(IcuFileSet32)"
			DestinationFolder="$(dir-outputBase)/lib/x86"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
			Condition="'$(OS)'=='Windows_NT'"
		/>
		<Copy
			SourceFiles="@(IcuFileSet64)"
			DestinationFolder="$(dir-outputBase)/lib/x64"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
			Condition="'$(OS)'=='Windows_NT'"
		/>
		<!-- LCM data files and headers (from contentFiles, not auto-deployed by NuGet) -->
		<!-- NOTE: LCM DLLs are now handled automatically by PackageReference -->
		<Copy
			SourceFiles="@(LcmOutputCommonFiles -&gt; '$(LcmArtifactsDir)/%(Identity)')"
			DestinationFolder="$(dir-fwoutputCommon)"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<Copy
			SourceFiles="@(LcmFwKernelFiles -&gt; '$(LcmArtifactsDir)/%(Identity)')"
			DestinationFolder="$(fwrt)/Src/Kernel"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<Copy
			SourceFiles="@(LcmDistFiles -&gt; '$(LcmModelArtifactsDir)/%(Identity)')"
			DestinationFolder="$(fwrt)/DistFiles"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<Copy
			SourceFiles="@(LcmTemplatesFiles -&gt; '$(LcmModelArtifactsDir)/%(Identity)')"
			DestinationFolder="$(fwrt)/DistFiles/Templates"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<Copy
			SourceFiles="@(LcmIcuDataFiles -&gt; '$(LcmArtifactsDir)/%(Identity)')"
			DestinationFolder="$(fwrt)/DistFiles/Icu$(IcuVersion)/data"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<Copy
			SourceFiles="@(LcmIcuNrmFiles -&gt; '$(LcmArtifactsDir)/%(Identity)')"
			DestinationFolder="$(fwrt)/DistFiles/Icu$(IcuVersion)/icudt$(IcuVersion)l"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<!-- Copy native/special-case artifacts that PackageReference doesn't handle automatically -->
		<ItemGroup>
			<ExistingPalasoFiles
				Include="@(PalasoFiles)"
				Condition="Exists('$(PalasoArtifactsDir)/%(Identity)')"
			/>
			<ExistingChorusFiles
				Include="@(ChorusFiles)"
				Condition="Exists('$(ChorusArtifactsDir)/%(Identity)')"
			/>
			<ExistingDownloadedFiles
				Include="@(DownloadedFiles)"
				Condition="Exists('%(Identity)')"
			/>
		</ItemGroup>
		<Warning
			Text="Missing Palaso native files (skipping): @(PalasoFiles)"
			Condition="'@(ExistingPalasoFiles)'!='' AND '@(PalasoFiles)'!='@(ExistingPalasoFiles)'"
		/>
		<Warning
			Text="Missing Chorus application files (skipping): @(ChorusFiles)"
			Condition="'@(ExistingChorusFiles)'!='' AND '@(ChorusFiles)'!='@(ExistingChorusFiles)'"
		/>
		<!-- Copy native Keyman/irrKlang/Interop.WIA files from Palaso packages -->
		<Copy
			SourceFiles="@(ExistingPalasoFiles -&gt; '$(PalasoArtifactsDir)/%(Identity)')"
			DestinationFolder="$(dir-outputBase)"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<!-- Copy Chorus.exe application -->
		<Copy
			SourceFiles="@(ExistingChorusFiles -&gt; '$(ChorusArtifactsDir)/%(Identity)')"
			DestinationFolder="$(dir-outputBase)"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<!-- Copy TeamCity artifacts (ExCss, GeckofxHtmlToPdf, HermitCrab, IPCFramework) -->
		<Copy
			SourceFiles="@(ExistingDownloadedFiles)"
			DestinationFolder="$(dir-outputBase)"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
		<!-- Rename GeckofxHtmlToPdf.exe to FieldWorksPdfMaker so it its origin is clear in case a user needs to release it from antivirus quarantine -->
		<!-- TODO: GeckofxHtmlToPdf needs to be built from https://github.com/sillsdev/geckofxHtmlToPdf and binaries placed in Downloads or DistFiles/Windows -->
		<Copy
			SourceFiles="$(DownloadsDir)/GeckofxHtmlToPdf.exe"
			DestinationFiles="$(dir-outputBase)/FieldWorksPdfMaker.exe"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
			Condition="Exists('$(DownloadsDir)/GeckofxHtmlToPdf.exe')"
		/>
		<Copy
			SourceFiles="$(DownloadsDir)/GeckofxHtmlToPdf.exe.config"
			DestinationFiles="$(dir-outputBase)/FieldWorksPdfMaker.exe.config"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
			Condition="Exists('$(DownloadsDir)/GeckofxHtmlToPdf.exe.config')"
		/>
		<!-- Encoding Converters Files (x64 only) -->
		<!-- Note: encoding-converters-core package doesn't follow standard NuGet runtime conventions
		     (has extra EcDistFiles folder), so automatic runtime asset copying doesn't work.
		     Manual copying required until package structure is fixed. -->
		<Copy
			SourceFiles="@(ECWindowsFiles -&gt; '$(PackagesDir)/encoding-converters-core/$(ECNugetVersion)/runtimes/EcDistFiles/win-x64/native/%(Identity)')"
			DestinationFolder="$(dir-outputBase)"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
			Condition="'$(OS)'=='Windows_NT'"
		/>
		<Copy
			SourceFiles="@(ECPlugins -&gt; '$(PackagesDir)/encoding-converters-core/$(ECNugetVersion)/runtimes/EcDistFiles/redist/EC/Plugins/%(Identity)')"
			DestinationFolder="$(dir-outputBase)/EC/Plugins"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
			Condition="'$(OS)'=='Windows_NT'"
		/>
		<!-- Native Geckofx package (complex multi-file layout requires manual copying) -->
		<PropertyGroup>
			<Architecture>64</Architecture>
			<GeckoDir Condition="'$(OS)'=='Windows_NT'"
				>$(PackagesDir)/Geckofx60.$(Architecture).60.0.56</GeckoDir
			>
		</PropertyGroup>
		<ItemGroup>
			<!-- Geckofx native browser engine (managed wrapper + native XULRunner files) -->
			<NuGottenFiles
				Include="$(GeckoDir)/lib/net45/*.*"
				Condition="'$(OS)'=='Windows_NT'"
			/>
			<NuGottenFiles Include="$(GeckoDir)/content/**/*.*" />
			<!-- NOTE: All other managed DLLs are now handled automatically by PackageReference.
			     MSBuild's automatic assembly resolution copies them to the output directory.
			     SIL.BuildTasks is now a PackageReference in FwBuildTasks.csproj. -->
		</ItemGroup>
		<Copy
			SourceFiles="@(NuGottenFiles)"
			DestinationFolder="$(dir-outputBase)/%(RecursiveDir)"
			SkipUnchangedFiles="true"
			OverwriteReadOnlyFiles="true"
		/>
	</Target>
	<Target Name="setRegistryValues" DependsOnTargets="initWindows;setKeysInHKCU" />
	<Target Name="setKeysInHKCU" Condition="'$(packaging)' != 'yes'">
		<Message Text="Setting registry values for $(fwrt)." />
		<!-- Using the OS-appropriate directory separator character is required for some unit tests to pass -->
		<WriteRegistry
			Hive="CurrentUser"
			Key="$(BUILDAGENT_HKCU)SOFTWARE/SIL/FieldWorks/$(FWMAJOR)/RootCodeDir"
			Value="$(dir-fwdistfiles)"
		/>
		<WriteRegistry
			Hive="CurrentUser"
			Key="$(BUILDAGENT_HKCU)SOFTWARE/SIL/FieldWorks/$(FWMAJOR)/RootDataDir"
			Value="$(dir-fwdistfiles)"
		/>
		<WriteRegistry
			Hive="CurrentUser"
			Key="$(BUILDAGENT_HKCU)SOFTWARE/SIL/FieldWorks/$(FWMAJOR)/ProjectsDir"
			Value="$([System.IO.Path]::Combine(&quot;$(dir-fwdistfiles)&quot;, &quot;Projects&quot;))"
		/>
		<WriteRegistry
			Hive="CurrentUser"
			Key="$(BUILDAGENT_HKCU)SOFTWARE/SIL/Icu$(IcuVersion)DataDir"
			Value="$(dir-icuData)"
		/>
		<WriteRegistry
			Hive="CurrentUser"
			Key="$(BUILDAGENT_HKCU)SOFTWARE/SIL/SilEncConverters40/RootDir"
			Value="$(dir-outputBase)"
			Condition="'$(OS)'=='Windows_NT'"
		/>
		<WriteRegistry
			Hive="CurrentUser"
			Key="$(BUILDAGENT_HKCU)SOFTWARE/SIL/SilEncConverters40/DeveloperPluginDir"
			Value="$(dir-outputBase)\EC\Plugins"
			Condition="'$(OS)'=='Windows_NT'"
		/>
		<MakeDir Directories="$(fwrt)/DistFiles/SIL/Repository" />
		<WriteRegistry
			Hive="CurrentUser"
			Key="$(BUILDAGENT_HKCU)SOFTWARE/SIL/EncodingConverterRepository/Registry"
			Value="$(fwrt)/DistFiles/SIL/Repository/mappingRegistry.xml"
		/>
		<!-- Register silfw:// link protocol -->
		<WriteRegistry
			Hive="CurrentUser"
			Key="$(BUILDAGENT_HKCU)SOFTWARE/Classes/silfw/"
			Value="URL:SILFW Protocol"
		/>
		<WriteRegistry
			Hive="CurrentUser"
			Key="$(BUILDAGENT_HKCU)SOFTWARE/Classes/silfw/URL Protocol"
		/>
		<WriteRegistry
			Hive="CurrentUser"
			Key="$(BUILDAGENT_HKCU)SOFTWARE/Classes/silfw/shell/open/command/"
			Value="&quot;$(dir-outputBase)/FieldWorks.exe&quot; %1"
		/>
	</Target>
</Project>
