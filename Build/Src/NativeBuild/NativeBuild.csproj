<?xml version="1.0" encoding="utf-8"?>
<Project
  DefaultTargets="Build"
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003"
  ToolsVersion="Current"
>
  <!--
    NativeBuild: Build orchestrator for native C++ component builds

    This project serves as a bridge between the MSBuild Traversal SDK (FieldWorks.proj)
    and the native build system (mkall.targets). It allows the traversal
    build to properly sequence native component builds before managed projects.

    The project doesn't produce any output itself - it's purely a build orchestrator.
    Uses traditional MSBuild format to avoid SDK package resolution overhead.
  -->
  <PropertyGroup>
    <Platform Condition="'$(Platform)'==''">x64</Platform>
    <Configuration Condition="'$(Configuration)'==''">Debug</Configuration>
    <!-- Set fwrt early so NuGet package restore can find packages -->
    <fwrt>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)..\..\..'))</fwrt>
    <!--
      NuGet Package Location Policy:
      - Host builds: Use nuget.config globalPackagesFolder (packages/)
      - Container builds: Use NUGET_PACKAGES env var (C:\.nuget\packages)
      The NUGET_PACKAGES env var takes precedence over RestorePackagesPath.
      See nuget.config for full documentation.
    -->
    <PackagesDir Condition="'$(NUGET_PACKAGES)' != ''">$(NUGET_PACKAGES)</PackagesDir>
    <PackagesDir Condition="'$(NUGET_PACKAGES)' == ''">$(fwrt)/packages</PackagesDir>
    <RestorePackagesPath>$(PackagesDir)</RestorePackagesPath>
  </PropertyGroup>
  <!-- Import the native build orchestration -->
  <Import Project="$(MSBuildThisFileDirectory)..\..\FwBuildTasks.targets" />
  <Import Project="$(MSBuildThisFileDirectory)..\..\SetupInclude.targets" />
  <Import Project="$(MSBuildThisFileDirectory)..\..\mkall.targets" />
  <Import Project="$(MSBuildThisFileDirectory)..\..\Windows.targets" />
  <Import Project="$(MSBuildThisFileDirectory)..\..\RegFree.targets" />
  <Import Project="$(MSBuildThisFileDirectory)..\..\Localize.targets" />
  <!-- Override computed paths after imports - SetupInclude.targets computes them wrong for nested projects -->
  <PropertyGroup>
    <!-- fwrt and PackagesDir already set above before imports -->
    <DownloadsDir>$(fwrt)/Downloads</DownloadsDir>
    <!-- Don't override LcmArtifactsDir - let mkall.targets set it from the package -->
  </PropertyGroup>
  <!-- Reference to sil.lcmodel.core package for contentFiles. -->
  <ItemGroup>
    <PackageReference Include="SIL.LCModel.Core" Version="$(LcmNugetVersion)" GeneratePathProperty="true">
      <IncludeAssets>none</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <!--
      Localization package references:
      These packages contain XLIFF translation files used by Build/Localize.targets.
      They must be explicitly referenced here because NativeBuild.csproj is a traditional
      MSBuild project, not an SDK-style project, so it doesn't inherit from Directory.Build.props.
    -->
    <PackageReference Include="SIL.Chorus.L10ns" Version="3.0.1">
      <IncludeAssets>none</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="SIL.LibPalaso.L10ns" Version="17.0.0">
      <IncludeAssets>none</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <!-- ICU library (needed for mkall.targets copy steps) -->
    <PackageReference Include="icu4c.win.fw.lib" Version="$(IcuNugetVersion)">
      <IncludeAssets>none</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
  </ItemGroup>
  <!-- Override the Build target to call native build instead -->
  <Target
    Name="Build"
    DependsOnTargets="allCppNoTest"
  >
    <Message Text="Native C++ components built successfully" Importance="high" />
  </Target>
  <!-- Ensure Clean works -->
  <Target Name="Clean" DependsOnTargets="CleanAll">
    <Message Text="Native C++ components cleaned" Importance="high" />
  </Target>
</Project>
