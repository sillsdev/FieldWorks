<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <WixLibsDir Condition="'$(WixLibsDir)'==''">$(MSBuildProjectDirectory)\..\FLExInstaller\libs</WixLibsDir>
    <DownloadsDir Condition="'$(DownloadsDir)'==''">$(MSBuildProjectDirectory)\..\Downloads</DownloadsDir>
  </PropertyGroup>

  <Target Name="BuildInstaller" DependsOnTargets="DownloadPrerequisites;BuildProcRunner">
    <Message Text="Building Installer..." Importance="high" />
    <MSBuild Projects="$(MSBuildProjectDirectory)\..\FLExInstaller\FieldWorks.Bundle.wixproj" Targets="Restore;Build" Properties="Configuration=$(Configuration);Platform=x64" />
  </Target>

  <Target Name="BuildProcRunner">
    <MSBuild Projects="$(MSBuildProjectDirectory)\..\FLExInstaller\Shared\ProcRunner\ProcRunner\ProcRunner.csproj" Targets="Restore;Build" Properties="Configuration=Release" />
  </Target>

  <Target Name="DownloadPrerequisites" DependsOnTargets="DownloadBundledInstallers;DownloadAndUnzipFonts">
    <Message Text="Prerequisites downloaded." Importance="high" />
  </Target>

  <Target Name="DownloadBundledInstallers">
    <MakeDir Directories="$(WixLibsDir)" Condition="!Exists('$(WixLibsDir)')" />
    <!-- .NET 4.8 -->
    <DownloadFile
      SourceUrl="https://go.microsoft.com/fwlink/?linkid=2088631"
      DestinationFolder="$(WixLibsDir)"
      DestinationFileName="ndp48-x86-x64-allos-enu.exe"
      Condition="!Exists('$(WixLibsDir)\ndp48-x86-x64-allos-enu.exe')"
    />
    <!-- VC++ Redists -->
    <DownloadFile
      SourceUrl="https://download.microsoft.com/download/5/D/8/5D8C65CB-C849-4025-8E95-C3966CAFD8AE/vcredist_x64.exe"
      DestinationFolder="$(WixLibsDir)"
      DestinationFileName="vcredist_2008_x64.exe"
      Condition="!Exists('$(WixLibsDir)\vcredist_2008_x64.exe')"
    />
    <DownloadFile
      SourceUrl="https://download.microsoft.com/download/1/6/5/165255E7-1014-4D0A-B094-B6A430A6BFFC/vcredist_x64.exe"
      DestinationFolder="$(WixLibsDir)"
      DestinationFileName="vcredist_2010_x64.exe"
      Condition="!Exists('$(WixLibsDir)\vcredist_2010_x64.exe')"
    />
    <DownloadFile
      SourceUrl="https://download.microsoft.com/download/1/6/B/16B06F60-3B20-4FF2-B699-5E9B7962F9AE/VSU_4/vcredist_x64.exe"
      DestinationFolder="$(WixLibsDir)"
      DestinationFileName="vcredist_2012_x64.exe"
      Condition="!Exists('$(WixLibsDir)\vcredist_2012_x64.exe')"
    />
    <DownloadFile
      SourceUrl="https://download.microsoft.com/download/0/5/6/056DCDA9-D667-4E27-8001-8A0C6971D6B1/vcredist_x64.exe"
      DestinationFolder="$(WixLibsDir)"
      DestinationFileName="vcredist_2013_x64.exe"
      Condition="!Exists('$(WixLibsDir)\vcredist_2013_x64.exe')"
    />
    <DownloadFile
      SourceUrl="https://download.visualstudio.microsoft.com/download/pr/36e45907-8554-4390-ba70-9f6306924167/97CC5066EB3C7246CF89B735AE0F5A5304A7EE33DC087D65D9DFF3A1A73FE803/VC_redist.x64.exe"
      DestinationFolder="$(WixLibsDir)"
      DestinationFileName="vcredist_2015-19_x64.exe"
      Condition="!Exists('$(WixLibsDir)\vcredist_2015-19_x64.exe')"
    />
    <!-- FLEx Bridge -->
    <DownloadFile
      SourceUrl="https://software.sil.org/downloads/r/fieldworks/FlexBridge_Offline_4.2.0.exe"
      DestinationFolder="$(WixLibsDir)"
      DestinationFileName="FLExBridge_Offline.exe"
      Condition="!Exists('$(WixLibsDir)\FLExBridge_Offline.exe')"
    />
  </Target>

  <Target Name="DownloadAndUnzipFonts">
    <MakeDir Directories="$(DownloadsDir)" Condition="!Exists('$(DownloadsDir)')" />
    <DownloadFile
      SourceUrl="http://www.quivira-font.com/files/Quivira.otf"
      DestinationFolder="$(MSBuildProjectDirectory)\..\DistFiles\Fonts\Raw"
      Condition="!Exists('$(MSBuildProjectDirectory)\..\DistFiles\Fonts\Raw\Quivira.otf')"
      ContinueOnError="true"
    />
    <DownloadFile
      SourceUrl="https://software.sil.org/downloads/r/andika/Andika-6.101.zip"
      DestinationFolder="$(DownloadsDir)"
      DestinationFileName="Andika-6.101.zip"
      Condition="!Exists('$(DownloadsDir)\Andika-6.101.zip')"
    />
    <DownloadFile
      SourceUrl="https://software.sil.org/downloads/r/charis/CharisSIL-6.101.zip"
      DestinationFolder="$(DownloadsDir)"
      DestinationFileName="CharisSIL-6.101.zip"
      Condition="!Exists('$(DownloadsDir)\CharisSIL-6.101.zip')"
    />
    <DownloadFile
      SourceUrl="https://software.sil.org/downloads/r/doulos/DoulosSIL-6.101.zip"
      DestinationFolder="$(DownloadsDir)"
      DestinationFileName="DoulosSIL-6.101.zip"
      Condition="!Exists('$(DownloadsDir)\DoulosSIL-6.101.zip')"
    />
    <DownloadFile
      SourceUrl="https://software.sil.org/downloads/r/gentium/GentiumPlus-6.101.zip"
      DestinationFolder="$(DownloadsDir)"
      DestinationFileName="GentiumPlus-6.101.zip"
      Condition="!Exists('$(DownloadsDir)\GentiumPlus-6.101.zip')"
    />

    <ItemGroup>
      <ZippedFonts Include="Andika-6.101;CharisSIL-6.101;DoulosSIL-6.101;GentiumPlus-6.101" />
    </ItemGroup>
    <Unzip
      SourceFiles="$(DownloadsDir)\%(ZippedFonts.Identity).zip"
      DestinationFolder="$(DownloadsDir)\Fonts"
      Condition="!Exists('$(DownloadsDir)\Fonts\%(ZippedFonts.Identity)')"
    />
  </Target>
</Project>
