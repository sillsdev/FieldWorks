<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="Current">
	<PropertyGroup>
		<FwBuildTasksAssembly Condition="'$(FwBuildTasksAssembly)'==''"
			>$(MSBuildThisFileDirectory)..\BuildTools\FwBuildTasks\$(Configuration)\FwBuildTasks.dll</FwBuildTasksAssembly
		>
	</PropertyGroup>
	<UsingTask TaskName="RegFree" AssemblyFile="$(FwBuildTasksAssembly)" />
	<PropertyGroup>
		<DistFilesDir Condition="'$(OutDir)' != ''">$(OutDir)../../DistFiles</DistFilesDir>
		<DistFilesDir Condition="'$(OutDir)' == ''"
			>$(MSBuildThisFileDirectory)../DistFiles</DistFilesDir
		>
	</PropertyGroup>
	<!-- Import Windows SDK paths to get mt.exe location -->
	<Import
		Project="$(VCTargetsPath)\Microsoft.Cpp.WindowsSDK.props"
		Condition="Exists('$(VCTargetsPath)\Microsoft.Cpp.WindowsSDK.props')"
	/>
	<PropertyGroup>
		<!-- Find mt.exe from Windows SDK - try multiple locations -->
		<MtExe
			Condition="'$(MtExe)' == '' And '$(WindowsSdkBinPath)' != '' And Exists('$(WindowsSdkBinPath)x64\mt.exe')"
			>$(WindowsSdkBinPath)x64\mt.exe</MtExe
		>
		<MtExe
			Condition="'$(MtExe)' == '' And '$(WindowsSDK_ExecutablePath_x64)' != '' And Exists('$(WindowsSDK_ExecutablePath_x64)mt.exe')"
			>$(WindowsSDK_ExecutablePath_x64)mt.exe</MtExe
		>
		<!-- Hardcoded fallback for common Windows 10 SDK location -->
		<MtExe
			Condition="'$(MtExe)' == '' And Exists('C:\Program Files (x86)\Windows Kits\10\bin\10.0.19041.0\x64\mt.exe')"
			>C:\Program Files (x86)\Windows Kits\10\bin\10.0.19041.0\x64\mt.exe</MtExe
		>
		<!-- Final fallback: assume mt.exe is in PATH (e.g., Developer Command Prompt) -->
		<MtExe Condition="'$(MtExe)' == ''">mt.exe</MtExe>
	</PropertyGroup>
	<!-- This file is included in BuildInclude.targets for each of our EXEs which use our COM components.
	It runs a custom task to create a manifest, then EXEC's a program to embed it in the EXE itself.
	This allows our programs to run without registering our COM DLLs, which in turn allows different
	versions of FieldWorks to coexist on the same computer. This is only relevant for Windows.
	Manifest files should have a different name from the dll to allow windows XP to load them.
	See: "Registration-Free Activation of COM Components: A Walkthrough"(http://msdn.microsoft.com/en-us/library/ms973913.aspx) Aug 2014 -->
	<ItemGroup>
		<DependentAssemblies Include="$(OutDir)FwKernel.X.manifest" />
		<DependentAssemblies Include="$(OutDir)Views.X.manifest" />
	</ItemGroup>
	<ItemGroup Condition="'@(NativeComDlls)' == ''">
		<!-- Explicitly list known native COM servers instead of wildcard inclusion -->
		<NativeComDlls Include="$(OutDir)GraphiteEngine.dll" />
		<NativeComDlls Include="$(OutDir)UniscribeEngine.dll" />
	</ItemGroup>
	<ItemGroup>
		<NativeComDlls Remove="$(OutDir)*.resources.dll" />
		<NativeComDlls Remove="$(OutDir)*.ni.dll" />
		<!-- Exclude DLLs that have their own manifests (redundant if not in include, but safe) -->
		<NativeComDlls Remove="$(OutDir)Views.dll" />
		<!-- FwKernel.dll is covered by FwKernel.X.manifest, but we need to ensure that manifest is populated.
		     For now, we assume it is or will be fixed. -->
		<NativeComDlls Remove="$(OutDir)FwKernel.dll" />
	</ItemGroup>
	<ItemGroup>
		<Fragments Include="$(DistFilesDir)/*.fragment.manifest" />
	</ItemGroup>
	<ItemGroup Condition="'@(ManagedComAssemblies)' == ''">
		<!-- Explicitly list managed assemblies that expose COM types -->
		<ManagedComAssemblies Include="$(OutDir)FwUtils.dll" />
		<ManagedComAssemblies Include="$(OutDir)SimpleRootSite.dll" />
		<ManagedComAssemblies Include="$(OutDir)ManagedLgIcuCollator.dll" />
		<ManagedComAssemblies Include="$(OutDir)ManagedVwWindow.dll" />
	</ItemGroup>
	<ItemGroup>
		<ManagedComAssemblies Remove="$(OutDir)*.resources.dll" />
		<ManagedComAssemblies Remove="$(OutDir)*.ni.dll" />
		<!-- Exclude native DLLs that are handled separately -->
		<ManagedComAssemblies Remove="$(OutDir)FwKernel.dll" />
		<ManagedComAssemblies Remove="$(OutDir)Views.dll" />
		<!-- Exclude 3rd party DLLs that cause manifest issues and don't need RegFree COM -->
		<ManagedComAssemblies Remove="$(OutDir)ProDotNetZip.dll" />
	</ItemGroup>

	<!-- Ensure we don't process managed assemblies as native type libraries in the main manifest -->
	<ItemGroup>
		<NativeComDlls Remove="@(ManagedComAssemblies)" />
	</ItemGroup>

	<!-- Phase 1: Generate individual manifests for managed assemblies -->
	<Target Name="CreateComponentManifests"
			Inputs="%(ManagedComAssemblies.Identity)"
			Outputs="$(OutDir)%(ManagedComAssemblies.Filename).manifest">
		<Message Text="Generating component manifest for %(ManagedComAssemblies.Filename) with Platform=$(Platform)" Importance="high" />
		<RegFree
			Executable="%(ManagedComAssemblies.Identity)"
			Output="$(OutDir)%(ManagedComAssemblies.Filename).manifest"
			ManagedAssemblies="%(ManagedComAssemblies.Identity)"
			Platform="$(Platform)"
			Condition="'$(OS)'=='Windows_NT'"
		/>
	</Target>

	<Target Name="CreateManifest" Condition="'$(OS)'=='Windows_NT'" DependsOnTargets="CreateComponentManifests">
		<ItemGroup>
			<ManagedComponentManifests Include="@(ManagedComAssemblies -> '$(OutDir)%(Filename).manifest')" />
			<ManagedComponentManifests Remove="@(ManagedComponentManifests)" Condition="!Exists('%(ManagedComponentManifests.Identity)')" />
			<!-- Add the generated component manifests as dependencies -->
			<DependentAssemblies Include="@(ManagedComponentManifests)" />
		</ItemGroup>
		<RegFree
			Executable="$(Executable)"
			DependentAssemblies="@(DependentAssemblies)"
			Dlls="@(NativeComDlls)"
			ManagedAssemblies=""
			AsIs="@(Fragments)"
			Platform="$(Platform)"
		/>
	</Target>
	<Target
		Name="AttachManifest"
		Condition="'$(OS)'=='Windows_NT'"
		DependsOnTargets="CreateManifest"
	>
		<Exec Command="&quot;$(MtExe)&quot; -nologo -manifest &quot;$(Executable).manifest&quot; -outputresource:&quot;$(Executable);#1&quot;" />
	</Target>
	<Target
		Name="RegFree"
		Condition="'$(OS)'=='Windows_NT'"
		DependsOnTargets="CreateManifest;AttachManifest"
	></Target>
	<Target Name="DebugRegFree" BeforeTargets="CreateManifest">
		<Message Text="OutDir: $(OutDir)" Importance="high" />
		<Message Text="NativeComDlls: @(NativeComDlls)" Importance="high" />
		<Message Text="RegFreeComManifests: @(RegFreeComManifests)" Importance="high" />
		<Message Text="IsolatedComReferences: @(IsolatedComReferences)" Importance="high" />
	</Target>
</Project>
