<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="Current" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<UsingTask TaskName="DownloadFile" AssemblyFile="FwBuildTasks.dll"/> <!-- needed because DownloadNuGet is called in a separate process -->

	<PropertyGroup>
		<NuGetToolsPath>$(MSBuildThisFileDirectory)</NuGetToolsPath>
		<PlatformPackagesConfig Condition="'$(OS)'=='Windows_NT'">$(NuGetToolsPath)nuget-windows/packages.config</PlatformPackagesConfig>
		<CommonPackagesConfig>$(NuGetToolsPath)nuget-common/packages.config</CommonPackagesConfig>

		<!-- NuGet command -->
		<NuGetExePath>$(NuGetToolsPath)NuGet.exe</NuGetExePath>
		<NuGetCommand Condition="'$(OS)' == 'Windows_NT'">"$(NuGetExePath)"</NuGetCommand>

		<!-- Command to download packages -->
		<RestoreCommandCommon>$(NuGetCommand) restore "$(CommonPackagesConfig)" -NonInteractive -PackagesDirectory "$(fwrt)/packages" -PackageSaveMode "nuspec;nupkg"</RestoreCommandCommon>
		<RestoreCommandPlatformSpecific>$(NuGetCommand) restore "$(PlatformPackagesConfig)" -NonInteractive -PackagesDirectory "$(fwrt)/packages" -PackageSaveMode "nuspec;nupkg"</RestoreCommandPlatformSpecific>
	</PropertyGroup>

	<Target Name="RestoreNuGetPackages" DependsOnTargets="CheckPrerequisites">
		<!-- Download packages in packages-common.config. Then download packages in packages-windows.config. -->
		<Exec Condition="'$(OS)' == 'Windows_NT'" Command="$(RestoreCommandCommon)"/>
		<Exec Condition="'$(OS)' == 'Windows_NT'" Command="$(RestoreCommandPlatformSpecific)"/>
		<!-- Run dotnet restore for SDK-style projects to generate project.assets.json -->
		<Exec Condition="'$(OS)' == 'Windows_NT'" Command="dotnet restore &quot;$(fwrt)/Src/Common/FwUtils/FwUtils.csproj&quot;" ContinueOnError="true" />
		<Exec Condition="'$(OS)' == 'Windows_NT'" Command="dotnet restore &quot;$(fwrt)/Src/Common/Filters/Filters.csproj&quot;" ContinueOnError="true" />
	</Target>

	<PropertyGroup>
		<NuGetUrl>https://dist.nuget.org/win-x86-commandline/latest/nuget.exe</NuGetUrl>
	</PropertyGroup>

	<Target Name="CheckPrerequisites">
		<!--
		Take advantage of MsBuild's build dependency tracking to make sure that we download nuget.exe only once ever.
		This effectively acts as a lock that makes sure that the download operation will only happen once and all
		parallel builds will have to wait for it to complete.
		-->
		<MSBuild Targets="DownloadNuGet" Projects="$(MSBuildThisFileFullPath)" Properties="Configuration=NOT_IMPORTANT;" />
	</Target>

	<Target Name="DownloadNuGet" Condition="!Exists('$(NuGetExePath)')">
		<Message Text="Downloading NuGet.exe." />
		<DownloadFile Address="$(NuGetUrl)" DownloadsDir="$(NuGetToolsPath)" Condition="'$(OS)' == 'Windows_NT'"/>
	</Target>

	<Target Name="CleanNuGet">
		<ForceDelete Files="$(NuGetExePath)"/>
		<ForceDelete Files="$(fwrt)/packages/"/>
		<ForceDelete Files="$(dir-outputBase)/Firefox/"/>
		<ForceDelete Files="$(dir-outputBase)/Firefox-Linux64/"/>
		<ForceDelete Files="$(dir-outputBase)/Firefox-Linux32/"/>
		<ForceDelete Files="$(dir-outputBase)/Geckofx-*.*"/>
		<Message Text="cleaned $(NuGetExePath) et al."/>
	</Target>
</Project>
