name: Build and Publish Docker Image

# Build and publish Windows Docker image to GitHub Container Registry
# Triggers when Dockerfile.windows or related files change on the primary branch
# Tags images with 'latest' and a version number based on run number

on:
  push:
    branches:
      - release/9.3
    paths:
      - 'Dockerfile.windows'
      - 'Post-Install-Setup.ps1'
      - 'VsDevShell.cmd'
      - '.github/workflows/docker-build-publish.yml'
  workflow_dispatch:
    inputs:
      tag_suffix:
        description: 'Optional tag suffix (e.g., "test" for fieldworks-build:latest-test)'
        required: false
        default: ''

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/fieldworks-build

jobs:
  build-and-push:
    runs-on: windows-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        run: |
          $imageName = "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          # Container registry names must be lowercase per OCI specification
          $imageName = $imageName.ToLower()
          
          # Create version number from run number (starts at 1)
          $version = "${{ github.run_number }}"
          
          # Build tags
          $tags = @()
          
          # Add latest tag (with optional suffix)
          $suffix = "${{ github.event.inputs.tag_suffix }}"
          if ($suffix) {
            $tags += "${imageName}:latest-${suffix}"
            $tags += "${imageName}:${version}-${suffix}"
          } else {
            $tags += "${imageName}:latest"
            $tags += "${imageName}:${version}"
          }
          
          # Output for next steps
          $tagsString = $tags -join ","
          Write-Host "Tags: $tagsString"
          
          # Set output (GitHub Actions style)
          "tags=${tagsString}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "version=${version}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh

      - name: Build Docker image
        run: |
          Write-Host "Building Docker image for Windows..."
          
          # Parse tags
          $tags = "${{ steps.meta.outputs.tags }}".Split(",")
          $tagArgs = @()
          foreach ($tag in $tags) {
            $tagArgs += "-t"
            $tagArgs += $tag.Trim()
          }
          
          Write-Host "Building with tags: $($tags -join ', ')"
          
          # Build the image (Windows containers must be built on Windows)
          & docker build @tagArgs -f Dockerfile.windows .
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Docker build failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          
          Write-Host "Docker build completed successfully"
        shell: pwsh

      - name: Push Docker image
        run: |
          Write-Host "Pushing Docker image to ${{ env.REGISTRY }}..."
          
          # Parse tags and push each one
          $tags = "${{ steps.meta.outputs.tags }}".Split(",")
          
          foreach ($tag in $tags) {
            $tag = $tag.Trim()
            Write-Host "Pushing: $tag"
            & docker push $tag
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to push $tag"
              exit $LASTEXITCODE
            }
          }
          
          Write-Host "All tags pushed successfully"
          Write-Host ""
          Write-Host "Image published as:"
          foreach ($tag in $tags) {
            Write-Host "  - $($tag.Trim())"
          }
        shell: pwsh

      - name: Summary
        run: |
          Write-Host "=== Docker Image Build and Push Complete ==="
          Write-Host ""
          Write-Host "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          Write-Host "Version: ${{ steps.meta.outputs.version }}"
          Write-Host "Tags: ${{ steps.meta.outputs.tags }}"
          Write-Host ""
          Write-Host "To use this image in workflows:"
          Write-Host "  container:"
          Write-Host "    image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          Write-Host "    credentials:"
          Write-Host "      username: \${{ github.actor }}"
          Write-Host "      password: \${{ secrets.GITHUB_TOKEN }}"
        shell: pwsh
